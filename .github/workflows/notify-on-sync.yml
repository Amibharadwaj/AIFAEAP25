name: Notify on Sync Changes

on:
  push:
    branches:
      - main

jobs:
  notify:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check if sync workflow triggered this
        id: check_sync
        run: |
          # Check last commit author
          AUTHOR=$(git log -1 --pretty=format:'%an')
          if [ "$AUTHOR" == "Sync Bot" ]; then
            echo "is_sync=true" >> $GITHUB_OUTPUT
          else
            echo "is_sync=false" >> $GITHUB_OUTPUT
          fi

      - name: Get commit details
        if: steps.check_sync.outputs.is_sync == 'true'
        id: commit_info
        run: |
          COMMIT_MSG=$(git log -1 --pretty=format:'%B')
          COMMIT_HASH=$(git log -1 --pretty=format:'%H' | cut -c1-7)
          COMMIT_DATE=$(git log -1 --pretty=format:'%ai')
          echo "message=$COMMIT_MSG" >> $GITHUB_OUTPUT
          echo "hash=$COMMIT_HASH" >> $GITHUB_OUTPUT
          echo "date=$COMMIT_DATE" >> $GITHUB_OUTPUT

      - name: Create notification message
        if: steps.check_sync.outputs.is_sync == 'true'
        id: notification
        run: |
          echo "NOTIFICATION_BODY=âœ… Sync completed successfully!\n\nRepository has been synchronized with source changes.\n\nCommit: ${{ steps.commit_info.outputs.hash }}\nTime: ${{ steps.commit_info.outputs.date }}\n\nView details: https://github.com/${{ github.repository }}/commit/${{ github.sha }}" >> $GITHUB_ENV

      - name: Send GitHub notification
        if: steps.check_sync.outputs.is_sync == 'true'
        run: |
          echo "ðŸ“¢ SYNC NOTIFICATION"
          echo "${{ env.NOTIFICATION_BODY }}"
          # Note: You can add webhook/Slack/email integration here

      # Optional: Send to Issues as a comment
      - name: Create notification issue comment
        if: steps.check_sync.outputs.is_sync == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: 1,
              body: 'âœ… Repository synced with source at commit ${{ steps.commit_info.outputs.hash }}'
            })
        continue-on-error: true
